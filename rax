#!/bin/bash
# rax: https://github.com/jverghese/rax

# Shell script based JSON parser.
# TODO: Add build file to inline this script.
. lib/JSON.sh

# Config
# Todo: Use rax_creds config variable wherever possible.
rax_creds="~/.raxcreds"

# URLs
auth_endpoint=https://auth.api.rackspacecloud.com/v1.1/auth

function retrieveCredentials() {
  if [ -f ~/.raxcreds ]
  then
    creds=$(cat ~/.raxcreds)
    username=$(echo $creds | cut -d ' ' -f1)
    api=$(echo $creds | cut -d ' ' -f2)
  else
    echo "Rax cred file not found."
    exit 1
  fi
}

function jsonPost() {
  echo "curl -i -H "Content-Type: application/json" -H "Accept: application/json" $*"
}

# Accepts $*: A list of other curl parameters.
function jsonPostWithCreds() {
  retval=$(curl -s -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"credentials": {"username": "'$username'","key": "'$api'"}}' $*)
}

# Parses JSON and returns the value.
function getJSONValue() {
  retval=$(echo $1 | tokenize | parse | \
         egrep '\["auth","token","id"]' | \
         awk -F "\t" '{print $NF}' | tr -d '"')
}

function updateConfigFile() {
  if [ -f ~/.rax ]
  then
    echo "Updating auth token in existing config file."
    rm ~/.rax; touch ~/.rax
    echo $1 >> ~/.rax
  else
    echo "Creating new config file with token."
    touch ~/.rax
    echo $1 >> ~/.rax
  fi
}

function getAuthToken() {
  if [ -f ~/.rax ]
  then
    retval=$(cat ~/.rax)
  else
    echo "Auth token not found."
    exit 1
  fi
}

function getServers() {
  curl -w "\n%{http_code}" -s -H 'Content-Type: application/json' -H 'Accept: application/json' -H 'X-Auth-Token: '$authtoken'' 'https://dfw.servers.api.rackspacecloud.com/v2/657527/servers'
}

# function read input from stdin and write output to the stdout
# caller must take care about where come stdin and where go stdout
# Note: This function is unused.
log()
{
  while read data
  do
      echo "[$(date +"%D %T")] $data"
  done
}

function callCommand() {
  case $1 in
    "auth")
      jsonPostWithCreds $auth_endpoint
      getJSONValue $retval
      updateConfigFile $retval;;
    "server")
      getAuthToken; authtoken=$retval;
      getServers;;
    "dashboard")
      getAuthToken; authtoken=$retval;
      open "https://sage-preprod.glimpse.rax.io/sso?authtoken=$authtoken";;
    *)
      echo "Invalid command: $1.";;
  esac
}

retrieveCredentials
callCommand $1
